{% extends 'admin/master.html' %}
{% import 'shelf/base/lib.html' as lib with context %}
{% import 'shelf/model/layout.html' as model_layout with context %}
{% import 'shelf/base/actions.html' as actionlib with context %}

{% block head_css %}
{{ super() }}
<link href="{{ url_for('admin.static', filename='select2/select2.css') }}" rel="stylesheet">
<link href="{{ url_for('admin.static', filename='datetimepicker/bootstrap-datetimepicker.css') }}" rel="stylesheet">
<style type="text/css" media="screen">
body.dragging, body.dragging * {
    cursor: move !important;
}
.dragged {
    position: absolute;
    opacity: 0.5;
    z-index: 2000;
}
</style>
{% endblock %}

{% block body %}
<div class="row" style="margin-top: 50px; background-color: #ffffff">
    <div class="col-xs-12" style="padding: 0px; padding-bottom: 15px; padding-top: 5px; padding-left: 25px;">
        {% block model_list_title %}
        <h1>{{ admin_view.name.upper() }} ({{ count }})</h1>
        <p class="select-all" style="font-size: 14px">
            <span>0</span> sur {{ data|length }} sélectionnés &#160;            
            <a style="display: none;" href="javascript:void(0)">Sélectionner tous les {{ count }} éléments</a>
        </p>
        <p class="select-none" style="display: none; font-size: 14px">
            Tous les {{ count }} sélectionnés &#160;            
            <a href="javascript:void(0)">Effacer la sélection</a>
        </p>
        {% endblock %}
    </div>
    <div class="col-xs-12" style="padding: 0px; padding-bottom: 15px; overflow: hidden">
        {% block model_list_table %}
        <table class="table model-list" style="border-top: 1px solid #ddd">
            <thead>
                <tr>
                    {% block list_header scoped %}
                    {% if actions %}
                    <th class="span1 center">
                        <input type="checkbox" name="rowtoggle" class="action-rowtoggle" />
                    </th>
                    {% endif %}

                    {% set column = 0 %}
                    {% for c, name in list_columns %}
                    <th>
                        {% if admin_view.is_sortable(c) %}
                        {% if sort_column == column %}
                        <a href="{{ sort_url(column, True) }}">
                            {{ name }}
                        </a>
                        {% if sort_desc %}
                        <span class="pull-right"><i class="fa fa-arrow-circle-up fa-lg"></i></span>
                        {% else %}
                        <span class="pull-right"><i class="fa fa-arrow-circle-down fa-lg"></i></span>
                        {% endif %}
                        {% else %}
                        <a href="{{ sort_url(column) }}">{{ name }}</a>
                        {% endif %}
                        {% else %}
                        {{ name }}
                        {% endif %}
                        {% if admin_view.column_descriptions.get(c) %}
                        <a class="icon-question-sign"
                        title="{{ admin_view.column_descriptions[c] }}"
                        href="javascript:void(0)" data-role="tooltip"
                        ></a>
                        {% endif %}
                    </th>
                    {% set column = column + 1 %}
                    {% endfor %}
                    {% block list_row_actions_header %}
                    <th>&nbsp;</th>
                    {% endblock %}
                    {% endblock %}
                </tr>
            </thead>
            {% for row in data %}
            <tr>
                {% block list_row scoped %}
                {% if actions %}
                <td class="center">
                    <input type="checkbox" name="rowid" class="action-checkbox" value="{{ get_pk_value(row) }}" />
                </td>
                {% endif %}                    
                {% for c, name in list_columns %}
                <td>{{ get_value(row, c) }}</td>
                {% endfor %}
                <td class="center">
                    {% block list_row_actions scoped %}
                    {%- if admin_view.can_edit -%}
                    <a class="icon" href="{{ url_for('.edit_view', id=get_pk_value(row), url=return_url) }}" style="padding-right: 6px">
                        <i class="fa fa-pencil fa-lg"></i>
                    </a>
                    {%- endif -%}
                    {%- if admin_view.can_delete -%}
                    <form class="icon form-inline" method="POST" action="{{ url_for('.delete_view', id=get_pk_value(row), url=return_url) }}">
                        <button type="submit" onclick="return confirm('{{ _gettext('You sure you want to delete this item?') }}');">
                            <i class="fa fa-times-circle fa-lg"></i>
                        </button>
                    </form>
                    {%- endif -%}
                    {% endblock %}
                </td>
                {% endblock %}
            </tr>
            {% endfor %}
        </table>
        {% endblock %}
    </div>
</div>

{{ actionlib.form(actions, "%s?%s" % (url_for('.action_view'), return_url.split('?')[1])) }}

{% if filter_groups %}
{{ lib.popup("filter-modal",
            model_layout.filter_header(),
            model_layout.filter_form(), 
            model_layout.filter_footer(filter_groups)) }}
{% endif %}
{% endblock %}



{% block tail %}
{{ lib.navbar(model_layout.list_left_bottom_bar, model_layout.list_right_bottom_bar, "%s (%d)" % (admin_view.name, count), pos="bottom") }}
{% endblock %}

{% block tail_js %}
{{ super() }}
<script src="{{ url_for('admin.static', filename='datetimepicker/bootstrap-datetimepicker.js') }}"></script>
<script src="{{ url_for('shelf.static', filename='shelf/js/form.js') }}"></script>
<script src="{{ url_for('shelf.static', filename='shelf/js/filter.js') }}"></script>
<script src="{{ url_for('shelf.static', filename='shelf/js/jquery-sortable.js') }}"></script>

{{ actionlib.script(_gettext('Please select at least one model.'),
                    actions,
                    actions_confirmation) }}

<script language="javascript">
(function($) {
    $('[data-role=tooltip]').tooltip({
        html: true,
        placement: 'bottom'
    });
    {% if filter_groups is not none and filter_data is not none %}
    var filter = new AdminFilters(
        '#filter_form', '.field-filters',
        {{ admin_view._filter_dict|tojson|safe }},
        {{ filter_data|tojson|safe }},
        {{ filter_types|tojson|safe }}
        );
    {% endif %}

    $('.select-all a').click(function(e) {
        $('.select-all').hide();
        $('.select-none').show();
        $('.model-list thead input.action-rowtoggle').prop('checked', true);
        $('#select-all').val("1");
    });

    $('.select-none a').click(function(e) {
        $('.select-none').hide();
        $('.select-all').show();
        $('.select-all a').hide();
        $('.select-all span').html('0');
        $('.model-list thead input.action-rowtoggle').prop('checked', false);
        $('.model-list tbody tr input.action-checkbox:checked').prop('checked', false);
        $('.model-list tbody tr.selected').removeClass('selected');
        $('#select-all').val("0");
    });

    $(".actions.apply").click(function(e) {
        $("#filter_form").submit();
    });

    $('.navbar-fixed-bottom .dropdown-menu').click(function (e) {
        e.stopPropagation();
    });

    $('.navbar-fixed-bottom .filter-menu > .dropdown-menu a').click(function (e) {
        var target = $(e.currentTarget).parent();
        if (target.hasClass('active'))
        {
            target.removeClass('active');
        }
        else
        {
            target.addClass('active');
        }
    });

    {% if has_order %}
    $('.model-list tbody').sortable({
      containerSelector: 'tbody',
      itemSelector: 'tr',
      placeholder: '<tr class="placeholder" style="height: 30px; border: 1px;"/>'
  });
    {% endif %}

    $('.model-list tbody tr').click(function (e) {
        /* state switch when row is clicked */
        if ($(this).hasClass('selected'))
        {            
            $(this).removeClass('selected');
            $(this).find('input.action-checkbox').prop("checked", false);
        }
        else
        {
            $(this).addClass('selected');
            $(this).find('input.action-checkbox').prop("checked", true);
        }

        /* changing count value */
        $('.select-all span').html($('.model-list tbody tr.selected').length);

        /* switching back to select all mode */
        $('.select-none').hide();
        $('.select-all').show();
        $('#select-all').val("0");

        /* if all is selected check head input */
        if ($('.model-list tbody tr.selected').length == $('.model-list tbody tr').length)
        {
            $('.model-list thead input.action-rowtoggle').prop('checked', true);
            $('.select-all a').show();
        }
        else
        {
            $('.model-list thead input.action-rowtoggle').prop('checked', false);
            $('.select-all a').hide();
        }

        if ($('.model-list tbody tr.selected').length > 0)
            $("li.actions.delete").removeClass('disabled');
        else
            $("li.actions.delete").addClass('disabled');
    });

    $('.model-list thead input.action-rowtoggle').change(function (e) {
        if ($(this).prop("checked") == true)
        {
            $('.model-list tbody tr').addClass('selected');
            $('.model-list tbody input.action-checkbox').prop("checked", true);
            $('.select-all a').show();
        }
        else 
        {
            $('.model-list tbody tr').removeClass('selected');
            $('.model-list tbody input.action-checkbox').prop("checked", false);
            $('.select-all a').hide();
            $('.select-none').hide();
            $('.select-all').show();
            $('#select-all').val("0");
        }

        $('.select-all span').html($('.model-list tbody tr.selected').length);
        if ($('.model-list tbody tr.selected').length > 0)
            $("li.actions.delete").removeClass('disabled');
        else
            $("li.actions.delete").addClass('disabled');

    });

    /* Set selected class on already checked row */
    $('.model-list tbody tr input.action-checkbox:checked').each(
        function (i, elem) {
            $(elem).closest('tr').addClass('selected');
        }
    );

    /* If all is selected; display select-all */
    if ($('.model-list tbody tr.selected').length == $('.model-list tbody tr').length)
    {
        $('.select-all a').show();
    }
    else
    {
        $('.select-all a').hide();
    }

    if ($('#select-all').val() == "1")
    {
        $('.select-all').hide();
        $('.select-none').show();
    }

    $('.select-all span').html($('.model-list tbody tr.selected').length);


})(jQuery);
</script>
{% endblock %}
