<script language="javascript" src="{{ url_for('shelf.static', filename='shelf/js/library_field.js') }}"></script>
<script language="javascript" src="{{ url_for('shelf.static', filename='jquery/jquery.cropit.js') }}"></script>
<script language="javascript">
(function($) {
    $('.model-form').on('click', "button.modal-open", function() {
        var input_el = $(this).closest('.form-group').find('input');
        var modal = $(this).closest('.form-group').find('.modal');

        if (input_el.hasClass('remote-file'))
        {
            modal.data('val-target', '#' + input_el.attr('id'));

            modal.modal({
                remote: "/admin/fileadmin/modal/",
                toggle: "modal"
            });
        }
        else if (input_el.hasClass('picture'))
        {
            var thumb_id = 'thumb_' + input_el.attr('id');
            var thumb_el = $(this).closest('.form-group').find('.thumbnail>img').first();

            thumb_el.attr('id', thumb_id);

            modal.data('val-target', '#' + input_el.attr('id'));
            modal.data('src-target', '#' + thumb_id);

            if (thumb_el.attr('width') && thumb_el.attr('height')) {
                modal.data('crop-width', thumb_el.attr('width'));
                modal.data('crop-height', thumb_el.attr('height'));

                modal.observe('added', '.modal_file_element', function(record) {
                    if (!$(this).data('width') || !$(this).data('height')) {
                        $(this).removeClass('modal_file_element');
                        return;
                    }

                    if ($(this).data('width') < thumb_el.attr('width') || $(this).data('height') < thumb_el.attr('height')) {
                        $(this).find('span.link-file').append('<span class="picture_too_small">ðŸš« picture too small</span>');
                        $(this).removeClass('modal_file_element');
                        return;
                    }

                    if ($(this).data('width') != thumb_el.attr('width') || $(this).data('width') != thumb_el.attr('width')) {
                        $(this).addClass('modal_crop_required');
                    }
                });
            }

            modal.modal({
                remote: "/admin/fileadmin/modal-icons/",
                toggle: "modal"
            }).on('hidden.bs.modal', function(e) {
                modal.disconnect();
            });
        }
        return false;
    });

    $('.model-form').on('click', "button.remove", function() {
        if ($(this).closest('.form-group').find('input').hasClass('remote-file'))
        {
            $(this).closest('.form-group').find('input').first().val('');
        }
        else if ($(this).closest('.form-group').find('input').hasClass('picture'))
        {
            $(this).closest('.form-group').find('img').first().attr('src', "/shelf/static/shelf/img/missing-picture.png");
            $(this).closest('.form-group').find('input[type=hidden]').first().val('');
        }
        return false;
    });
})(jQuery);
</script>
